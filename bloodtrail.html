<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>BuckFinders ‚Äì Blood-Trail Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html,body,#map{height:100%;margin:0}
  .hud{position:fixed;left:0;right:0;top:0;display:grid;gap:8px;
       grid-template-columns: repeat(4,1fr);padding:10px;background:linear-gradient(#000a,#0000);
       z-index:1000}
  .btn{appearance:none;border:1px solid #ffffff40;border-radius:10px;padding:10px 12px;
       font:600 14px system-ui,sans-serif;color:#fff;background:#121212cc;backdrop-filter:blur(6px)}
  .btn[aria-pressed="true"]{outline:2px solid #4caf50}
  .row{grid-column:1/-1;display:flex;gap:8px;align-items:center;justify-content:space-between}
  .sel,.txt{flex:1;min-width:0;border-radius:10px;border:1px solid #ffffff40;background:#121212cc;color:#fff;padding:10px}
  .stats{position:fixed;left:10px;bottom:10px;color:#fff;font:13px/1.3 system-ui;background:#121212cc;border:1px solid #ffffff40;border-radius:10px;padding:8px 10px;z-index:1000}
  .bearingArrow{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:16px solid #fff; transform-origin:50% 12px;}
  .leaflet-container{background:#000}
</style>
</head>
<body>

<div class="hud">
  <button id="gps" class="btn" aria-pressed="false">üìç Start GPS</button>
  <button id="drop" class="btn">ü©∏ Drop Blood</button>
  <button id="undo" class="btn">‚Ü©Ô∏è Undo</button>
  <button id="clear" class="btn">üóëÔ∏è Clear</button>

  <div class="row">
    <select id="type" class="sel" title="Blood amount">
      <option value="light" selected>Light blood</option>
      <option value="good">Good blood</option>
      <option value="heavy">Heavy blood</option>
      <option value="none">No blood / track sign</option>
      <option value="other">Other</option>
    </select>
    <input id="note" class="txt" placeholder="Add quick note (optional)" />
  </div>

  <div class="row">
    <button id="export" class="btn">‚¨áÔ∏è Export (JSON)</button>
    <input id="importFile" type="file" accept="application/json" class="btn" style="padding:8px"/>
    <button id="copy" class="btn">üìã Copy</button>
    <button id="help" class="btn">‚ùî Help</button>
  </div>
</div>

<div id="map"></div>
<div class="stats">
  <div>Total distance: <b id="tot">0</b> yd</div>
  <div>Last segment: <b id="seg">0</b> yd</div>
  <div>To next bearing: <span id="brg">‚Äì</span></div>
</div>

<script>
const map = L.map('map',{zoomControl:false}).setView([38.5,-95.0], 5);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '&copy; OSM'}).addTo(map);
L.control.zoom({position:'bottomright'}).addTo(map);

const colors = {
  light:'#ffd166',
  good:'#ff7b00',
  heavy:'#ff1e1e',
  none:'#9e9e9e',
  other:'#7ad3ff'
};

let trail = [];         // [{lat,lng,type,note,ts}]
let poly = L.polyline([], {color:'#ff5252', weight:4}).addTo(map);
let markers = [];       // L.circleMarker refs
let gpsWatch = null;
let nextArrow = L.divIcon({html:'<div class="bearingArrow"></div>', className:'', iconSize:[0,0]});
let arrowMarker = L.marker([0,0],{icon:nextArrow, interactive:false}).addTo(map).setOpacity(0);

// UI elements
const $ = s=>document.querySelector(s);
const btnGPS=$('#gps'), btnDrop=$('#drop'), btnUndo=$('#undo'), btnClear=$('#clear');
const btnExport=$('#export'), fileImport=$('#importFile'), btnCopy=$('#copy'), btnHelp=$('#help');
const selType=$('#type'), inNote=$('#note');
const elTot=$('#tot'), elSeg=$('#seg'), elBrg=$('#brg');

function yards(m){ return Math.round(m*1.09361); }
function bearing(a,b){
  const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
  const œÜ1=toRad(a.lat), œÜ2=toRad(b.lat), Œª1=toRad(a.lng), Œª2=toRad(b.lng);
  const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

function updateStats(){
  const latlngs = poly.getLatLngs();
  let total=0, seg=0;
  for(let i=1;i<latlngs.length;i++){ total += latlngs[i-1].distanceTo(latlngs[i]); }
  if(latlngs.length>=2) seg = latlngs[latlngs.length-2].distanceTo(latlngs[latlngs.length-1]);
  elTot.textContent = yards(total);
  elSeg.textContent = yards(seg);
  // bearing to next (last two points)
  if(latlngs.length>=2){
    const brg = bearing(latlngs[latlngs.length-2], latlngs[latlngs.length-1]);
    elBrg.textContent = `${Math.round(brg)}¬∞`;
    arrowMarker.setLatLng(latlngs[latlngs.length-2]).setOpacity(1);
    const deg = Math.round(brg);
    arrowMarker.getElement()?.querySelector('.bearingArrow').style.transform = `rotate(${deg}deg) translateY(-6px)`;
  } else {
    elBrg.textContent = '‚Äì';
    arrowMarker.setOpacity(0);
  }
  localStorage.setItem('bf_trail', JSON.stringify(trail));
}

function addPoint(lat, lng, type, note){
  trail.push({lat,lng,type,note,ts:Date.now()});
  const m = L.circleMarker([lat,lng], {
    radius: 8, color:'#000', weight:1,
    fillColor: colors[type] || '#fff', fillOpacity: 0.95
  }).addTo(map);
  if(note){ m.bindPopup(`<b>${type}</b><br>${note}`); }
  markers.push(m);
  poly.addLatLng([lat,lng]);
  if(trail.length===1) map.setView([lat,lng], 17);
  updateStats();
}

btnDrop.addEventListener('click', ()=>{
  if(!lastGPS){ alert('Tip: turn on GPS or long-press on the map to drop at a spot.'); return; }
  addPoint(lastGPS.lat, lastGPS.lng, selType.value, inNote.value.trim());
  inNote.value='';
});

btnUndo.addEventListener('click', ()=>{
  if(!trail.length) return;
  trail.pop();
  const m = markers.pop(); if(m){ map.removeLayer(m); }
  const latlngs = poly.getLatLngs(); latlngs.pop(); poly.setLatLngs(latlngs);
  updateStats();
});

btnClear.addEventListener('click', ()=>{
  if(!confirm('Clear trail?')) return;
  trail = []; markers.forEach(m=>map.removeLayer(m)); markers=[];
  poly.setLatLngs([]); updateStats();
});

btnExport.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({version:1, trail}, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'buckfinders_bloodtrail.json';
  a.click();
});

btnCopy.addEventListener('click', async ()=>{
  try{
    await navigator.clipboard.writeText(JSON.stringify({version:1,trail}));
    alert('Copied JSON to clipboard!');
  }catch(e){ alert('Copy failed: '+e); }
});

fileImport.addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const data = JSON.parse(txt);
    if(!data.trail) throw 'No trail array';
    // Clear, then load
    btnClear.click();
    data.trail.forEach(p=> addPoint(p.lat, p.lng, p.type||'other', p.note||''));
    map.fitBounds(poly.getBounds(), {padding:[40,40]});
  }catch(err){ alert('Import failed: '+err); }
  e.target.value='';
});

btnHelp.addEventListener('click', ()=>alert(
`HOW TO USE
‚Ä¢ Tap ‚ÄúStart GPS‚Äù to follow your position (works offline once loaded).
‚Ä¢ Tap ‚ÄúDrop Blood‚Äù to pin your current location with a color + note.
‚Ä¢ Long-press anywhere on the map to drop a pin at that spot.
‚Ä¢ ‚ÄúUndo‚Äù removes the last point. ‚ÄúClear‚Äù wipes the trail.
‚Ä¢ ‚ÄúExport‚Äù saves a JSON file; ‚ÄúImport‚Äù loads it back later.
Tips:
‚Ä¢ Keep phone level and wait a second for GPS to settle before dropping a pin.
‚Ä¢ Distances shown are straight-line (useful for estimating total track).`
));

// Long-press add point anywhere
let pressTimer=null;
map.on('mousedown touchstart', (e)=>{
  pressTimer = setTimeout(()=>{
    const type = selType.value;
    const note = inNote.value.trim();
    addPoint(e.latlng.lat, e.latlng.lng, type, note);
    inNote.value='';
  }, 450);
});
map.on('mouseup mouseleave touchend', ()=>{ clearTimeout(pressTimer); });

// GPS
let lastGPS=null;
function onGPS(pos){
  const {latitude, longitude} = pos.coords;
  lastGPS = {lat:latitude, lng:longitude};
  // soft follow; don‚Äôt throw zoom around while adding pins
  if(poly.getLatLngs().length===0) map.setView(lastGPS, 18);
  // show a faint dot for current position
  if(!self._me){
    self._me = L.circleMarker(lastGPS, {radius:6, color:'#00e5ff', fillColor:'#00e5ff', fillOpacity:.9}).addTo(map);
  } else {
    self._me.setLatLng(lastGPS);
  }
}
function onGPSError(err){ console.warn(err.message); }
function toggleGPS(){
  if(gpsWatch){
    navigator.geolocation.clearWatch(gpsWatch);
    gpsWatch = null;
    btnGPS.setAttribute('aria-pressed','false');
    btnGPS.textContent='üìç Start GPS';
  }else{
    if(!('geolocation' in navigator)) return alert('GPS not available on this device.');
    gpsWatch = navigator.geolocation.watchPosition(onGPS, onGPSError, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    btnGPS.setAttribute('aria-pressed','true');
    btnGPS.textContent='üì° GPS On';
  }
}
btnGPS.addEventListener('click', toggleGPS);

// Restore autosave
try{
  const saved = localStorage.getItem('bf_trail');
  if(saved){
    JSON.parse(saved).forEach(p=> addPoint(p.lat, p.lng, p.type||'other', p.note||''));
    if(poly.getLatLngs().length) map.fitBounds(poly.getBounds(), {padding:[40,40]});
  }
}catch{}

</script>
</body>
</html>
